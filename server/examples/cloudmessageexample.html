<!DOCTYPE html>
<!-- 
Project Name: SPIKE Prime Web Interface
File name: cloudmessageexample.html
Author: Jeremy Jung
Last update: 6/24/20
Description: example of changing systemlink tags and getting its values from the cloud on a web page
Credits/inspirations:
    Based on UJSONRPC Web Serial by Ethan Danahy, Olga Sans
History: 
    Created by Jeremy on 6/19/20
LICENSE: MIT
(C) Tufts Center for Engineering Education and Outreach (CEEO)

-->
<html>
    <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src = "hoverscript_jquery.js" type = "text/javascript"></script>
    <link rel = "stylesheet" href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css">
    <body>
        <head>
            <title>
                System Link Cloud (PRIME display) example
            </title>
        </head>
        <div id = "container">
            <div id = "navbar_container" style = "height: 50px; width: 50px; z-index: 1px;"></div>
            <div id = "syslink_container" style = "position: absolute;"></div>
            <div id = "ujsonrpc_container" style = "position: absolute;"></div>
            <div id = "ujsonrpc_send_container" style = "position: absolute;"></div>

            <!-- load the UJSONRPC component-->
            <script>
                $(function(){
                    try {
                        $('#ujsonrpc_container').load('UJSON_interface.html', () => {
                            //toggle automatic get_value and display_text of "messsage" tag
                            function toggle_autoget() {
                                console.log("here boi")
                                if (auto_get) {
                                    auto_get = false;
                                    clearInterval(getvalueInt)
                                } else {
                                    auto_get = true;
                                    getvalueInt = setInterval( async () => {
                                            message_value = await display_image_value()
                                            if (message_value != last_message) {
                                                last_message = message_value
                                                $("#send").click()
                                            }
                                        }, 1000
                                    )
                                }
                            }

                            $("#autoget").on("click", () => {
                                    console.log("yo")
                                    toggle_autoget()
                            });
                        })
                    }
                    catch (e){
                        console.log(e);
                    }
                });
            </script> 
            <!-- load the systemlink component-->
            <script>
                $(function(){
                    try {
                        $('#syslink_container').load('syslink_interface.html')
                    }
                    catch (e){
                        console.log(e);
                    }
                });
            </script> 
            <!-- load the navbar component-->
            <script>
                $(function(){
                    try {
                        $('#navbar_container').load('navbar.html')
                    }
                    catch (e){
                        console.log(e);
                    }
                });
            </script> 
            <!-- load the UJSONRPC send component-->
            <script>
                $(function(){
                    try {
                        $('#ujsonrpc_send_container').load('UJSONRPC_send.html')
                    }
                    catch (e){
                        console.log(e);
                    }
                });
            </script> 
        </div>
    </body>
    <!-- when document loads -->
    <script>
        var APIkey = ""
        var all_tags = [];
        var auto_get = false;
        navbar = true;
        //run when document is done loading
        $(document).ready(new function() {
            console.log("daddy's home");
            //check APIkey and display available tags whenever there is input
            $("#keyinputfield").on("input", async function (event) {
                if( await auth_key($("#keyinputfield").val()) ) {
                    $("#key_valid").html("Valid APIkey!");
                    APIkey = $("#keyinputfield").val();
                    //get all tag names from cloud and display it on UI
                    await get_tag_list(APIkey).then(
                        (tags_list) => update_tag_selects(tags_list), 
                        (tags_list) => all_tags = tags_list
                    );
                    //display the first selected tag
                    display_select_value();
                    get_value_interval()
                    //display UJSON command with current value of "message" when webpage loads
                    last_message = display_image_value()
                }
                

            });

        });
    </script>

    <!-- Example specific scripts -->
    <script>
        //modify UJSONRPC request and display current value of "message" tag
        async function display_image_value() {
            var value = await get_value(APIkey, "message")
            $("#data").val('{"i":' + Math.floor((Math.random()*10000)) +', "m": "scratch.display_text", "p": {"text":"'  + value + '"} }')
            current_message = value
            return value
        }
    </script>
    <!--
    script for JSONRPC (specfically jsonrpcbox) 
    <script>
        let connectbutton = document.getElementById('connect');
        let REPL = document.getElementById('REPL');
        let sendbutton = document.getElementById("send");
        let rebootButton =  document.getElementById("reboot");
        var current_message
        var getvalueInt

        // SEND Hub Reboot (control-C + control-D)
        rebootButton.addEventListener('click', async() => {
            reboot_hub()
        });

        sendbutton.addEventListener('click', async() => {
            sendDATA(document.getElementById("data").value);
        });

        //set or change the interval at which data is retrieved
        var setInt
        async function change_retrieval_interval() {
            console.log($("#delay_amount").val())
            clearInterval(setInt)
            setInt = setInterval( async () => {
                retrieve_data().then((value => REPL.value = value))
            }, $("#delay_amount").val() * 1000
            )
        }

        connectbutton.addEventListener('click', async() => {
            await setup_port()
            read_stream()
        });

        //modify UJSONRPC request and display current value of "message" tag
        async function display_image_value() {
            var value = await get_value(APIkey, "message")
            $("#data").val('{"i":' + Math.floor((Math.random()*10000)) +', "m": "scratch.display_text", "p": {"text":"'  + value + '"} }')
            current_message = value
            return value
        }

        //sleep function
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        //toggle automatic get_value and display_text of "messsage" tag
        function toggle_autoget() {
            console.log("here boi")
            if (auto_get) {
                auto_get = false;
                clearInterval(getvalueInt)
            } else {
                auto_get = true;
                getvalueInt = setInterval( async () => {
                        message_value = await display_image_value()
                        if (message_value != last_message) {
                            last_message = message_value
                            $("#send").click()
                        }
                    }, 1000
                )
            }
        }

        change_retrieval_interval()
        
    </script>
    -->
    <!-- script for SytemLink interaction (specifically statusbox) -->
    <!--
    <script>
        //update the scroll down list with available tags
        function update_tag_selects(tags_list) { 
            var number_of_tags = tags_list.length
            console.log("total count:" + number_of_tags)
            for (var i = 0; i < number_of_tags; i++) {
                var select_element = $("<option></option>").text(tags_list[i])
                $("#tagSelect").append(select_element)
            }
        }

        //shows the selected tag's current value
        async function display_select_value() {
            var selected_option = $("#tagSelect option:selected").text(); 
            get_value(APIkey, selected_option).then((value) => $("#currVal").text(value))
        }
        
        //change the current value of tag
        async function change_current_value() {
            var selected_option = await $("#tagSelect option:selected").text(); 
            var new_value = await $("#tagValInput").val();
            console.log("new_value", new_value)
            console.log("selected option", selected_option)
            var exists = false;
            console.log("newvalue", new_value)
            for (var i = 0; i < all_tags.length; i++) {
                if ( all_tags[i] == selected_option ) {
                    exists = true;
                }
            }
            //check type of new_value
            var inputType = input_type(new_value);
            await update_value(APIkey, selected_option, inputType, new_value);
            display_select_value();
        }


        //returns the data type indicator of tag based on given argument
        function input_type(new_value) {
            //if the value is not a number
            if ( isNaN(new_value) ) {
                //if the value is a boolean
                if (new_value == "true" || new_value == "false") {
                    return "BOOLEAN";
                }
                //if the value is a string
            return "STRING"; 
            }
            //value is a number
            else {
                //if value is an integer
                if ( Number.isInteger(parseFloat(new_value)) ) {
                    return "INT"
                }
                //if value is a double
                else {
                    return "DOUBLE"
                }
            }
        }

        async function get_value_interval() {
                getValInt = setInterval( async () => {
                display_select_value()
                }, 1000
            )
        }
    </script>
    -->
</html>