<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <div id = "changeLEGOSpeed">
            <div id = "currentSpeed"> Ethan's Current Motor Speed: </div>
            <input type="range" min="-100" max="100" value="0" class="slider" id="speedRange">
        </div>
        <div id = "changeMessage">
            <div id="currentMessage"> Jeremy's Last Message on Hub: </div>
            <input type = "text" id="text" value = "Hello World!"></textarea>
            <div>
                <input type="button" id="display" value="display">
            </div>
        </div>
    </body>
    <script>
        
        // instantiate systemlink service object
        var mySL = new Service_SystemLink();
        
        var LEGOSpeed;
        var message;

        var currentSpeed;
        var currentMessage;

        var currentSpeedDIV = document.getElementById("currentSpeed");
        var currentMessageDIV = document.getElementById("currentMessage");
        var textArea = document.getElementById("text");
        var changeButton = document.getElementById("display");

        window.addEventListener("load", function () {
            mySL.init();
        })

        var slider = document.getElementById("speedRange");
        LEGOSpeed = parseFloat(slider.value); // Display the default slider value
        console.log(LEGOSpeed);

        // Update the LEGOSpeed when slider is scrolled
        slider.oninput = function () {
            LEGOSpeed = parseFloat(this.value);
            /* update tag values */
            mySL.setTagValue("LEGODEMOSpeed", LEGOSpeed);
        }
        
        mySL.executeAfterInit( async function () {

            /* update tag values */
            await mySL.setTagValue("LEGODEMOSpeed", LEGOSpeed);

            currentSpeed = await mySL.getTagValue("LEGODEMOSpeed");
            currentMessage = await mySL.getTagValue("message");

            /* update and get "LEGOSpeed" and "message" tag values every 100 miliseconds */
            var SLInterval = setInterval(async function () {

                /* get all tags on the cloud */
                var tagsInfo = await mySL.getTagsInfo();

                /* get "LEGOSpeed" and "message" tag values */
                currentSpeed = tagsInfo.LEGODEMOSpeed.value;
                currentMessage = tagsInfo.message.value;

                currentSpeedDIV.innerHTML = "Ethan's Current Motor Speed: " + currentSpeed;
                currentMessageDIV.innerHTML = "Jeremy's Last Message on Hub: " + currentMessage;

            }, 100);

            changeButton.addEventListener("click", function () {
                
                message = textArea.value;
                console.log("message", message);
                console.log("typeof message", typeof message);
                mySL.setTagValue("message", message);
            })

        });
        
        function Service_SystemLink() { let n = {}, e = "daciN5xlHb-J_eABvDQPRIYt4jrKmbUbCl-Zc2vta7", t = !1, a = 1e3; var r = void 0; async function o(n) { new Promise(async function (n, t) { var a = {}, r = await i("GET", "https://api.systemlinkcloud.com/nitag/v2/tags-with-values", e); r.onload = async function () { for (var e = JSON.parse(this.response), t = e.tagsWithValues, r = e.totalCount, o = 0; o < r; o++)try { var i = t[o].current.value.value, u = t[o].current.value.type, c = t[o].tag.path, l = await s(u, i); (v = {}).value = l, v.type = u, a[c] = v } catch (n) { var v; i = null, u = t[o].tag.type, c = t[o].tag.path; (v = {}).value = i, v.type = u, a[c] = v } n(a) }, r.onerror = function () { console.log(this.response), t(new Error("Error at getTagsInfoFromCloud")) } }).then(function (e) { n(e) }, function (e) { n(e) }) } async function i(n, e, t, a) { var r = new XMLHttpRequest; if (r.open(n, e, !0), r.setRequestHeader("x-ni-api-key", t), void 0 === a) r.setRequestHeader("Accept", "application/json"), r.send(); else { r.setRequestHeader("Content-type", "application/json"); var o = JSON.stringify(a); try { r.send(o) } catch (n) { console.log("error sending request:", r.response) } } return r } function s(n, e) { return "BOOLEAN" == n ? "true" == e : "STRING" == n ? e : "INT" == n || "DOUBLE" == n ? parseFloat(e) : e } return { init: async function (t, s) { return void 0 !== t && (e = t), !!await async function (n) { return new Promise(async function (e, t) { var a = await i("GET", "https://api.systemlinkcloud.com/niauth/v1/auth", n); a.onload = function () { var n = JSON.parse(a.response); n.error ? t(new Error("Error at apikey auth:", n)) : (console.log("APIkey is valid"), e(!0)) }, a.onerror = function () { var n = JSON.parse(a.response); t(new Error("Error at apikey auth:", n)) } }) }(e) && (void 0 !== s && (a = await s), async function (e) { o(function (t) { t && (n = t), setInterval(async function () { o(function (e) { e && (n = e) }) }, a), e() }) }(function () { active = !0, void 0 !== r && r() }), !0) }, getTagsInfo: async function () { return n }, setTagValue: async function (n, t) { return async function (n, t) { return new Promise(async function (a, r) { var o, s = "https://api.systemlinkcloud.com/nitag/v2/tags/" + n + "/values/current", u = (o = t, isNaN(o) ? "true" == o || "false" == o ? "BOOLEAN" : "STRING" : Number.isInteger(parseFloat(o)) ? "INT" : "DOUBLE"); if ("STRING" != u) var c = JSON.stringify(t), l = { value: { type: u, value: c } }; else var l = { value: { type: u, value: t } }; var v = l, f = await i("PUT", s, e, v); f.onload = function () { a(!0) }, f.onerror = function () { r(new Error("Error at updateTAagValue")) } }) }(n, t) }, getTagValue: async function (e) { return n[e].value }, executeAfterInit: function (n) { r = n }, setAPIKey: function (n) { e = n }, isActive: function () { return t } } }
    </script>
    <style>

        #changeLEGOSpeed {
            font-size: 20px;
            position:absolute;

            left: 50%;
            top: 25%;

            background-color: rgb(40, 165, 153);
            width: 400px;
            height: 200px;
            border:solid;
        }

        #display {
            font-size: 20px;
        }

        #speedRange {
            width: 300px;
        }

        #text {
            height: 125px;
            width: 200px;
            font-size: 20px;
        }

        #changeMessage {
            font-size: 20px;
            position: absolute;
            
            left: 10%;
            top: 25%;

            background-color: rgb(40, 165, 153);
            width: 400px;
            height: 200px;
            border:solid;
        }

        body {
            background-color: #4CE0D2;
        }

    </style>
</html>