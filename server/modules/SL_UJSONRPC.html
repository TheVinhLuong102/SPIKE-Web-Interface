<!DOCTYPE html>
<!-- 
Project Name: SPIKE Prime Web Interface
File name: SL_UJSONRPC.html
Author: Jeremy Jung
Last update: 7/7/20
Description: module to be loaded into servicedockexample 
            for sending  UJSONRPC commands to hub with data 
            from SystemLink
* this module can only run with service dock *
Credits/inspirations:
History: 
    Created by Jeremy on 7/7/20
LICENSE: MIT
(C) Tufts Center for Engineering Education and Outreach (CEEO)
-->

<!-- load global libraries -->
<script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src = "SLajaxlib.js" type = "text/javascript"></script>
<script src = "hoverscript_jquery.js" type = "text/javascript"></script>
<script src = "UJSONRPClib.js" type = "text/javascript"></script>
<div id = "slujsonbox">
    <center>
        <head>
            SystemLink driven UJSON RPC
        </head>
        <!---
        <div id = "all_selects">
            <select id = "slujson_rpcSelect">
            </select>
            <select id = "slujson_portSelect">
                <option>port</option>
            </select>
            <select id = "slujson_tagSelect">
            </select>
        </div>
        -->
        <textarea cols=60 rows=5 id="slujson_data" name="data" value="" style="font-family: Courier; position: relative; left: 20px" /></textarea>
        <input id = "slujson_send" type = "submit" value = "send">
    </center>
</div>
<script>
    //{"i":1212, "m": "scratch.display_text", "p": { "text": cloudTagValue(message) } }
    var command = {
        "m": "placeholder",
        "p": "placeholder"
    }
    var parameters = {
        "port": ['A', 'B', 'C', 'D', 'E', 'F'],
        "lights": ['upper-left', 'upper-right', 'lower-left', 'lower-right'],
        "image": ['ANGRY', 'ARROW_E', 'ARROW_N', 'ARROW_NE', 'ARROW_NW', 'ARROW_S', 'ARROW_SE', 'ARROW_SW', 
                'ARROW_W', 'ASLEEP', 'BUTTERFLY', 'CHESSBOARD', 'CLOCK1', 'CLOCK10', 'CLOCK11', 'CLOCK12', 'CLOCK2', 'CLOCK3', 'CLOCK4', 
                'CLOCK5', 'CLOCK6', 'CLOCK7', 'CLOCK8', 'CLOCK9', 'CONFUSED', 'COW', 'DIAMOND', 'DIAMOND_SMALL', 'DUCK', 'FABULOUS', 'GHOST', 'GIRAFFE', 'GO_RIGHT', 'GO_LEFT', 
                'GO_IP', 'GO_DOWN', 'HAPPY', 'HEART', 'HEART_SMALL', 'HOUSE', 'MEH', 'MUSIC_CROTCHET', 'MUSIC_QUAVER', 'MUSIC_QUAVERS', 'NO', 'PACMAN', 'PITCHFORK', 'RABBIT', 
                'ROLLERSKATE', 'SAD', 'SILLY', 'SKULL', 'SMILE', 'SNAKE', 'SQUARE', 'SQUARE_SMALL', 'STICKFIGURE', 'SURPRISED', 'SWORD', 'TARGET', 'TORTOISE', 'TRIANGLE', 'TRIANGLE_LEFT', 'TSHIRT', 
                'UMBRELLA', 'XMAS', 'YES']
    }

    var APIkey = "";
    var all_tags = [];
    
    var check_APIkey_and_port_connected;
    check_APIkey_and_port_connected = setInterval( async () => {
        //check connection variables at servicedock and UJSONRPC interface
        if (port_connected) {
            if (APIkey_valid_at_SD) {
                clearInterval(check_APIkey_and_port_connected);
                APIkey = await SD_APIkey;
                console.log("collected APIkey at SL_UJSONRPC", APIkey);
                //get all tag names from cloud and display it on UI
                await get_tag_list(APIkey).then(
                    (tags_list) => all_tags = tags_list
                );
                initSelects();
                $("#slujson_data").val('{"i":' + Math.floor((Math.random()*10000)) +', "m": "scratch.display_text", "p": {"text":'  + "cloudTagValue(message)" + '} }')
                /*
                SLUJSON_get_value_int = setInterval( async () => {
                    selected_option = 
                    get_value(APIkey, selected_option).then((value) => $("#currVal").text(value))
                })*/
            }
        }
    }, 500)

    var available_scripts = ["display_image", "display_text"];
    $(document).ready( () => {
        dragElement("slujsonbox")

        var slujson_send = document.getElementById("slujson_send");
        slujson_send.addEventListener("click", async () => {
            praseSLUJSONcommand();
        })
    })

    async function initSelects() {
        for (var i = 0; i < available_scripts.length; i++) {
            var select_element = $("<option></option>").text(available_scripts[i])
            $("#slujson_rpcSelect").append(select_element)
        }

        //using tags_list variable from sd_syslink_interface.html
        console.log("all_tags", all_tags)
        var number_of_tags = all_tags.length
        console.log("total count:" + number_of_tags)
        for (var i = 0; i < number_of_tags; i++) {
            var select_element = $("<option></option>").text(all_tags[i])
            $("#slujson_tagSelect").append(select_element)
        }
    }
    //parse the cloudTagValue() command inserted at the textbox and execute it
    async function praseSLUJSONcommand() {
        let dataInput = document.getElementById("slujson_data");
        let raw_string = dataInput.value;
        let index_cloudTagValue = await raw_string.indexOf("cloudTagValue(");
        //find the index of raw_string at which the cloudTagValue function ends
        let index_lastparen = await raw_string.indexOf( ")" , index_cloudTagValue );
        //divide the raw_string into parts before the getValue and after
        let first_raw_string_part = await raw_string.substring(0,index_cloudTagValue);
        let second_raw_string_part = await raw_string.substring(index_lastparen+1, raw_string.length);

        //find the argument of the cloudTagValue and get its info from the cloud
        let cloudTagValue_string = await raw_string.substring( index_cloudTagValue , index_lastparen + 1 );
        let index_first_paren = cloudTagValue_string.indexOf("(");
        let index_last_paren = cloudTagValue_string.indexOf(")");
        let tagName = cloudTagValue_string.substring(index_first_paren + 1,index_last_paren);
        let selectedTagValue = await get_value(APIkey, tagName);
        //send the final UJSONRPC script to the hub.
        let final_RPC_command;
        if (selectedTagValue.type == "STRING") {
            console.log("this was run")
            final_RPC_command = await first_raw_string_part + '"' + selectedTagValue.value + '"' + second_raw_string_part;
        }
        else if (selectedTagValue.type == "INT") {
            final_RPC_command = await first_raw_string_part + selectedTagValue.value + second_raw_string_part;
        }
        sendDATA(final_RPC_command);
    }
</script>

<style>
     #slujsonbox{
        width: 600px;
        height: 150px;
        background-color:#4CE0D2;
        position: absolute;
        border: solid;
    }

    #data{
        position: relative;
        top: 20px;
    }
</style>