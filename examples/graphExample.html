<!DOCTYPE html>
<!-- 
Project Name: SPIKE Prime Web Interface
File name: graphExample.html
Author: Jeremy Jung
Last update: 6/25/20
Description: example of reading ultrasonic sensor readings and visualizing it
Credits/inspirations:
    Based on UJSONRPC Web Serial by Ethan Danahy, Olga Sans
History: 
    Created by Jeremy on 6/25/20
LICENSE: MIT
(C) Tufts Center for Engineering Education and Outreach (CEEO)

USAGE: 
- connect ultrasonic sensor to port B on SPIKE Prime
- observe graph by slowly moving your hand closer or further from the sensor
-->
<html>
    <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src = "../libraries/JSONRPClib.js" type = "text/javascript"></script>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.plot.ly/plotly-latest.js" charset="utf-8"></script>
    <body>
        <head>
            <link rel = "stylesheet" type = "text/css" href = "../libraries/styles/style.css">
            <title>
                Graph Example
            </title>
        </head>
            <div id = "BrowserExplanation">
                <input type=button id="togglex" value="hide">
                <center>
                <p>Browser Setup (once):</p>
                </center>
                <ol>
                    <li>Open this webpage in a Chrome Browser</li>
                    <li>Go to the URL: chrome://flags</li>
                    <li>Search "Experimental Web Platform"</li>
                    <li><em>ENABLE</em> Experimental Web Platform (#enable-experimental-web-platform-features)</li>
                    <li>Restart your Chrome web browser</li>
                    <li>Plug in your SPIKE Prime hub by USB to this computer (and turn it on)!</li>
                    <li>Click "Connect" below and look for device: <em>"LEGO Technic Large Hub"</em></li>
                </ol>
                <center>
                <p><em><b>Once enabled, now you can play:</b></em></p>
                </center>

            </div>
            <div id = "graphbox">
                <div id="chart"></div>
                <script>
                    //when ultrasonic sensor connected to port B
                    async function getData() {
                        data = await retrieve_data()
                        let parsed
                        try {
                            parsed = await JSON.parse(data)
                            //sensor reading
                            result = parsed.p[1][1][0]
                            //console.log(result)
                            return result
                        }
                        catch (e) {

                        }
                    }
                    Plotly.plot('chart',[{
                        y:[getData()],
                        type:'line'
                    }]);
                    
                    var cnt = 0;
                    setInterval(async function(){
                        datapoint = await getData()
                        Plotly.extendTraces('chart',{ y:[[datapoint]]}, [0]);
                        cnt++;
                        if(cnt > 500) {
                            Plotly.relayout('chart',{
                                xaxis: {
                                    range: [cnt-500,cnt]
                                }
                            });
                        }
                    },15);
                </script>
            </div>
            <div id = "jsonrpcbox">
                    <center>
                        <p>
                            UJSON RPC
                        </p>
                        <input type=button id="connect" name="Connect" value="Connect">
                        <span style="background-color: red" id="connection_status">Status: Disconnected</span>
                        <input type=button id="reboot" name="Send Hub Reboot" value="Send Hub Reboot">
                        <em>Live Feed refresh every <input type="text" value="1" size="4" id="delay_amount" onchange = change_retrieval_interval() /> seconds</em>
                        <textarea cols=120 rows=5 id="REPL" name="REPL" value="" style="font-family: Courier" /></textarea>
                </center>
            </div>
        </div>
    </body>
    <!-- when document loads -->
    <script>
        var browserEx = true;
        var auto_get = false;
        explain = true;
        //run when document is done loading
        $(document).ready(new function() {
            console.log("daddy's home");
            
            $("#delay_amount").on("input", function (event) {
                change_retrieval_interval()
            });

            $("#autoget").on("click", () => {
                toggle_autoget()
            });

            //TODO: debug
            $("#togglex").on("click", () => {
                toggleEx()
            })
        });

        //toggle explanation
        function toggleEx() {
            if (explain) {
                $("#BrowserExplanation").css("display","none");
                explain = false;
            }
            else {
                $("#BrowserExplanation").css("display","block");
                explain = true;
            }
        }
    </script>

    <!-- script for JSONRPC (specfically jsonrpcbox) -->
    <script>
        let connectbutton = document.getElementById('connect');
        let REPL = document.getElementById('REPL');
        let sendbutton = document.getElementById("send");
        let rebootButton =  document.getElementById("reboot");
        var current_message
        var getvalueInt

        // SEND Hub Reboot (control-C + control-D)
        rebootButton.addEventListener('click', async() => {
            reboot_hub()
        });

        var setInt
        async function change_retrieval_interval() {
            console.log($("#delay_amount").val())
            clearInterval(setInt)
            setInt = setInterval( async () => {
                retrieve_data().then((value => REPL.value = value))
            }, $("#delay_amount").val() * 1000
            )
        }

        connectbutton.addEventListener('click', async() => {
            await setup_port()
            read_stream()
        });

        //sleep function
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        //display current value when webpage loads
        change_retrieval_interval()
    </script>
</html>