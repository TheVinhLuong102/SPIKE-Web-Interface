<!DOCTYPE html>
<!-- 
Project Name: SPIKE Prime Web Interface
File name: cloudmessageexample.html
Author: Jeremy Jung
Last update: 6/24/20
Description: example of changing systemlink tags and getting its values from the cloud on a web page
Credits/inspirations:
    Based on UJSONRPC Web Serial by Ethan Danahy, Olga Sans
History: 
    Created by Jeremy on 6/19/20
LICENSE: MIT
(C) Tufts Center for Engineering Education and Outreach (CEEO)

USAGE: 
- change the "message" tag to an arbitrary string
- watch the message below change to your message, hit send to see your message on the SPIKE
OR
- press "autoGET" button ONCE
- change the "message" tag on https://www.systemlinkcloud.com/data
- watch the SPIKE display your new message
-->
<html>
    <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src = "../libraries/SLajaxlib.js" type = "text/javascript"></script>
    <script src = "../libraries/JSONRPClib.js" type = "text/javascript"></script>
    <link rel = "stylesheet" href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css">
    <body>
        <head>
            <link rel = "stylesheet" type = "text/css" href = "../libraries/styles/msgexstyle.css">
            <title>
                System Link Cloud (PRIME display) example
            </title>
        </head>
        <div id = "container">
            <div id = "syslinkbox">
                <div class="square">
                    <p id = "keyprompt">
                        <center>
                            API Key
                            <input type = "text" id = "keyinputfield">
                            <span id = "key_valid"> Invalid </span>
                        </center>
                    </p>
                    <div id = "tagModification">
                        <center>
                            <p>
                                Create or update a tag:
                            </p>
                            <form id = "tagForm">
                                <select id = "tagSelect" onchange = display_select_value()></select>
                                <input type = "text" id = "tagValInput">
                                <button id = "updateTagValue" type = "button" > Submit</button>
                            </form>
                        </center>
                        <span id = "currValspan" style="position: relative; left: 20px" > Current value: <span id = "currVal"></span> </span>
                    </div>
                    <span id = "whatshappening"></span>
                </div>
            </div>
            <div id = "jsonrpcbox">
                    <center>
                        <p>
                            UJSON RPC
                        </p>
                        <input type=button id="connect" name="Connect" value="Connect">
                        <span style="background-color: red" id="connection_status">Status: Disconnected</span>
                        <input type=button id="reboot" name="Send Hub Reboot" value="Send Hub Reboot">
                        <em>Live Feed refresh every <input type="text" value="1" size="4" id="delay_amount" onchange = change_retrieval_interval() /> seconds</em>
                        <button id = "autoget" onclick = >autoGET</button>
                    </center>
                        <textarea cols=120 rows=5 id="REPL" name="REPL" value="" style="font-family: Courier;position: relative; left: 20px"/></textarea>
                        <textarea cols=120 rows=5 id="data" name="data" value="" style="font-family: Courier; position: relative; left: 20px" /></textarea>
                        <input type=button id="send" name="Send" value="Send" style="font-family: Courier; position: relative; left: 20px">
            </div>
            <!-- Testing html modules
            <script>
                $(function(){
                    try {
                        $('body').load('/modules/navbar.html #navbarDIV', function(){
                            console.log("Load was performed")
                        })
                    }
                    catch (e){
                        console.log(e);
                    }
                });
            </script>
            -->
            <button id = "navbarbutton" class="btn"><i class="fa fa-bars"></i></button>
            <div id = "navbar" style="z-index:100;">
                <ul>
                    <li id = "browsersetup" style="z-index:100;"><a>Browser Setup</a></li>
                    <li id = "usage" style="z-index:100;"><a>Usage</a></li>
                </ul>
            </div>
            <div id = "BrowserExplanation" style = "left:200px; display:none;">
                <center>
                <p>Browser Setup (once):</p>
                </center>
                <ol>
                    <li>Open this webpage in a Chrome Browser</li>
                    <li>Go to the URL: chrome://flags</li>
                    <li>Search "Experimental Web Platform"</li>
                    <li><em>ENABLE</em> Experimental Web Platform (#enable-experimental-web-platform-features)</li>
                    <li>Restart your Chrome web browser</li>
                    <li>Plug in your SPIKE Prime hub by USB to this computer (and turn it on)!</li>
                    <li>Click "Connect" below and look for device: <em>"LEGO Technic Large Hub"</em></li>
                </ol>
                <center>
                <p><em><b>Once enabled, now you can play:</b></em></p>
                </center>
            </div>
            <div id = "DemoExplanation" style = "left:200px; display:none;">
                <center>
                <p>Demonstration 1) Changing hub display with systemlink:</p>
                </center>
                <ol>
                    <li> On Google Chrome, open cloudmessageexample.html on one tab and syslinkbasic.html on another tab </li>
                    <li> Connect your SPIKE Prime to the computer, and please do Browser Setup if you haven't. </li>
                    <li> On cloudmessageexample.html, Press "connect", and select your port. </li>
                    <li>On both html pages, copy & paste the APIkey into the "APIkey" box ( daciN5xlHb-J_eABvDQPRIYt4jrKmbUbCl-Zc2vta7 )</li>
                    <li>On cloudmessageexample.html, press the "autoGET" button once. (This will display "message" on the hub whenever it's changed)</li>
                    <li>On the syslinkbasic.html, scroll the tags list and select, "message". Change the value to whatever string you'd like.</li>
                    <li>Watch the SPIKE Prime display your message</li>
                </ol>
            </div>
        </div>

    </body>
    <!-- when document loads -->
    <script>
        var APIkey = ""
        var all_tags = [];
        var auto_get = false;
        navbar = true;
        //run when document is done loading
        $(document).ready(new function() {
            console.log("daddy's home");
            //check APIkey and display available tags whenever there is input
            $("#keyinputfield").on("input", async function (event) {
                if( await auth_key($("#keyinputfield").val()) ) {
                    $("#key_valid").html("Valid APIkey!");
                    APIkey = $("#keyinputfield").val();
                    //get all tag names from cloud and display it on UI
                    await get_tag_list(APIkey).then(
                        (tags_list) => update_tag_selects(tags_list), 
                        (tags_list) => all_tags = tags_list
                    );
                    //display the first selected tag
                    display_select_value();
                    get_value_interval()
                    //display UJSON command with current value of "message" when webpage loads
                    last_message = display_image_value()
                }
            });

            $("#delay_amount").on("input", function (event) {
                change_retrieval_interval()
            });

            //when "Submit" button is clicked, update value
            $("#updateTagValue").on("click", async () => {
                $("#whatshappening").text("sending request to cloud to change value")
                await change_current_value()
                $("#whatshappening").text("getting value of \"message\" from cloud")
                current_message = await display_image_value()
                $("#whatshappening").text("changing JSON RPC command's input field")
            });

            $("#autoget").on("click", () => {
                toggle_autoget()
            });

            $("#togglex").on("click", () => {
                toggleEx()
            })

            $("#navbarbutton").on("click", () => {
                toggle_navbar();
                $("#navbar").find("a.active").removeClass("active");
            })

            $("#browsersetup").on("click", () => {
                $("#navbar").find("a.active").removeClass("active");
                $("#browsersetup").find("a").addClass("active");
                $("#DemoExplanation").css("display","none");
                $("#BrowserExplanation").css("display","block");
            })

            $("#usage").on("click", () => {
                $("#navbar").find("a.active").removeClass("active");
                $("#usage").find("a").addClass("active");
                $("#BrowserExplanation").css("display","none");
                $("#DemoExplanation").css("display","block");
            })
        });

        //toggle navigation bar
        function toggle_navbar() {
            if ( navbar ) {
                $("#navbar").css("display","none");
                $("#BrowserExplanation").css("display","none");
                $("#DemoExplanation").css("display","none");
                navbar = false;
            }
            else {
                $("#navbar").css("display","block");
                navbar = true;
            }
        }
    </script>

    <!-- script for JSONRPC (specfically jsonrpcbox) -->
    <script>
        let connectbutton = document.getElementById('connect');
        let REPL = document.getElementById('REPL');
        let sendbutton = document.getElementById("send");
        let rebootButton =  document.getElementById("reboot");
        var current_message
        var getvalueInt

        // SEND Hub Reboot (control-C + control-D)
        rebootButton.addEventListener('click', async() => {
            reboot_hub()
        });

        sendbutton.addEventListener('click', async() => {
            sendDATA(document.getElementById("data").value);
        });

        //set or change the interval at which data is retrieved
        var setInt
        async function change_retrieval_interval() {
            console.log($("#delay_amount").val())
            clearInterval(setInt)
            setInt = setInterval( async () => {
                retrieve_data().then((value => REPL.value = value))
            }, $("#delay_amount").val() * 1000
            )
        }

        connectbutton.addEventListener('click', async() => {
            await setup_port()
            read_stream()
        });

        //modify UJSONRPC request and display current value of "message" tag
        async function display_image_value() {
            var value = await get_value(APIkey, "message")
            $("#data").val('{"i":' + Math.floor((Math.random()*10000)) +', "m": "scratch.display_text", "p": {"text":"'  + value + '"} }')
            current_message = value
            return value
        }

        //sleep function
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        //toggle automatic get_value and display_text of "messsage" tag
        function toggle_autoget() {
            console.log("here boi")
            if (auto_get) {
                auto_get = false;
                clearInterval(getvalueInt)
            } else {
                auto_get = true;
                getvalueInt = setInterval( async () => {
                        message_value = await display_image_value()
                        if (message_value != last_message) {
                            last_message = message_value
                            $("#send").click()
                        }
                    }, 1000
                )
            }
        }

        change_retrieval_interval()
        
    </script>

    <!-- script for SytemLink interaction (specifically statusbox) -->
    <script>
        //update the scroll down list with available tags
        function update_tag_selects(tags_list) { 
            var number_of_tags = tags_list.length
            console.log("total count:" + number_of_tags)
            for (var i = 0; i < number_of_tags; i++) {
                var select_element = $("<option></option>").text(tags_list[i])
                $("#tagSelect").append(select_element)
            }
        }

        //shows the selected tag's current value
        async function display_select_value() {
            var selected_option = $("#tagSelect option:selected").text(); 
            get_value(APIkey, selected_option).then((value) => $("#currVal").text(value))
        }
        
        //change the current value of tag
        async function change_current_value() {
            var selected_option = await $("#tagSelect option:selected").text(); 
            var new_value = await $("#tagValInput").val();
            console.log("new_value", new_value)
            console.log("selected option", selected_option)
            var exists = false;
            console.log("newvalue", new_value)
            for (var i = 0; i < all_tags.length; i++) {
                if ( all_tags[i] == selected_option ) {
                    exists = true;
                }
            }
            //check type of new_value
            var inputType = input_type(new_value);
            await update_value(APIkey, selected_option, inputType, new_value);
            display_select_value();
        }


        //returns the data type indicator of tag based on given argument
        function input_type(new_value) {
            //if the value is not a number
            if ( isNaN(new_value) ) {
                //if the value is a boolean
                if (new_value == "true" || new_value == "false") {
                    return "BOOLEAN";
                }
                //if the value is a string
            return "STRING"; 
            }
            //value is a number
            else {
                //if value is an integer
                if ( Number.isInteger(parseFloat(new_value)) ) {
                    return "INT"
                }
                //if value is a double
                else {
                    return "DOUBLE"
                }
            }
        }

        async function get_value_interval() {
                getValInt = setInterval( async () => {
                display_select_value()
                }, 1000
            )
        }
    </script>
</html>