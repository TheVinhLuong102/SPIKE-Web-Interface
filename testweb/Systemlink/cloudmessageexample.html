<!DOCTYPE html>
<html>
    <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src = "libraries/SLajaxlib.js" type = "text/javascript"></script>
    <script src = "libraries/JSONRPClib.js" type = "text/javascript"></script>
    <body>
        <head>
            <link rel = "stylesheet" type = "text/css" href = "style.css">
            <title>
                System Link Cloud (PRIME display) example
            </title>
        </head>
        <div id = "container">
            <div id = "BrowswerExplanation">
                <center>
                <p>Browser Setup (once):</p>
                </center>
                <ol>
                    <li>Open this webpage in a Chrome Browser</li>
                    <li>Go to the URL: chrome://flags</li>
                    <li>Search "Experimental Web Platform"</li>
                    <li><em>ENABLE</em> Experimental Web Platform (#enable-experimental-web-platform-features)</li>
                    <li>Restart your Chrome web browser</li>
                    <li>Plug in your SPIKE Prime hub by USB to this computer (and turn it on)!</li>
                    <li>Click "Connect" below and look for device: <em>"LEGO Technic Large Hub"</em></li>
                </ol>
                <center>
                <p><em><b>Once enabled, now you can play:</b></em></p>
                </center>
            </div>
            
            <div id = "statusbox">
                <div class="square">
                    <p id = "keyprompt">
                        <center>
                            API Key
                            <input type = "text" id = "keyinputfield">
                            <span id = "key_valid"> Invalid </span>
                        </center>
                    </p>
                    <div id = "tagModification">
                        <center>
                            <p>
                                Create or update tag:
                            </p>
                            <form id = "tagForm">
                                <select id = "tagSelect" onchange = display_select_value()></select>
                                <input type = "text" id = "tagValInput">
                                <button id = "updateTagValue" type = "button" > Submit</button>
                            </form>
                        </center>
                        <span id = "currValspan"> Current value: <span id = "currVal"></span> </span>
                    </div>
                    <span id = "whatshappening"></span>
                </div>
            </div>
            <div id = "jsonrpcbox">
                    <center>
                        <p>
                            JSON RPC
                        </p>
                        <input type=button id="connect" name="Connect" value="Connect">
                        <span style="background-color: red" id="connection_status">Status: Disconnected</span>
                        <input type=button id="reboot" name="Send Hub Reboot" value="Send Hub Reboot">
                        <em>Live Feed refresh every <input type="text" value="1" size="4" id="delay_amount" onchange = retrieve_every() /> seconds</em>
                    </center>
                    <textarea cols=120 rows=5 id="REPL" name="REPL" value="" style="font-family: Courier" /></textarea>
                    <textarea cols=120 rows=5 id="data" name="data" value="" style="font-family: Courier" />
                    </textarea>
                    <input type=button id="send" name="Send" value="Send">
            </div>
        </div>
        </div>
    </body>
    <!-- when document loads -->
    <script>
        var APIkey = ""
        var all_tags = [];

        //run when document is done loading
        $(document).ready(new function() {
            console.log("daddy's home");
            //check APIkey and display available tags whenever there is input
            $("#keyinputfield").on("input", async function (event) {
                if( await auth_key($("#keyinputfield").val()) ) {
                    $("#key_valid").html("Valid APIkey!");
                    APIkey = $("#keyinputfield").val();
                    //get all tag names from cloud and display it on UI
                    await get_tag_list(APIkey).then(
                        (tags_list) => update_tag_selects(tags_list), 
                        (tags_list) => all_tags = tags_list
                    );
                    //display the first selected tag
                    display_select_value();
                }
            });

            $("#delay_amount").on("input", function (event) {
                change_retrieval_interval()
            });

            //when "Submit" button is clicked, update value
            $("#updateTagValue").on("click", async () => {
                $("#whatshappening").text("sending request to cloud to change value")
                await change_current_value()
                $("#whatshappening").text("getting value of \"message\" from cloud")
                current_message = await display_image_value()
                $("#whatshappening").text("changing JSON RPC command's input field")
            });

        });
    </script>

    <!-- script for JSONRPC (specfically jsonrpcbox) -->
    <script>
        let connectbutton = document.getElementById('connect');
        let REPL = document.getElementById('REPL');
        let sendbutton = document.getElementById("send");
        let rebootButton =  document.getElementById("reboot");

        // SEND Hub Reboot (control-C + control-D)
        rebootButton.addEventListener('click', async() => {
            reboot_hub()
        });

        sendbutton.addEventListener('click', async() => {
            sendDATA(document.getElementById("data").value);
        });

        var setInt
        async function change_retrieval_interval() {
            console.log($("#delay_amount").val())
            clearInterval(setInt)
            setInt = setInterval( async () => {
                retrieve_data().then((value => REPL.value = value))
            }, $("#delay_amount").val() * 1000
            )
        }

        connectbutton.addEventListener('click', async() => {
            await setup_port()
            read_stream()
        });

        var current_message
        apikey = "daciN5xlHb-J_eABvDQPRIYt4jrKmbUbCl-Zc2vta7"

        //modify UJSONRPC request and display current value of "message" tag
        async function display_image_value() {
            $("#whatshappening").text("changed display_text script")
            var value = await get_value(apikey, "message")
            $("#imageVal").text(value)
            $("#data").val('{"i":' + Math.floor((Math.random()*10000)) +', "m": "scratch.display_text", "p": {"text":"'  + value + '"} }')
            current_message = value
            return value
        }

        //sleep function
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        //change current value of "message" on cloud and then read the current value FROM THE CLOUD
        async function change_message() {
            $("#whatshappening").text("sending request to cors server proxy")
            var selected_option = $("#tagSelect option:selected").text(); 
            //make a request to change value to "HELLO" to systemlink
            if (selected_option == "Hello") {
                await $.ajax({
                    url: "http://localhost:3000/hello"
                })
            }
            //make a request to change value to "GOODBYE" to systemlink
            else {
                await $.ajax({
                    url: "http://localhost:3000/goodbye"
                })
            }
            $("#whatshappening").text("cors proxy is sending put request to Systemlink cloud")
            current_message = await display_image_value()
            $("#whatshappening").text("tag was successfully changed")
        }

        //display current value when webpage loads
        display_image_value()
        change_retrieval_interval()

    </script>
    <!-- script for SytemLink interaction (specifically statusbox) -->
    <script>
        //update the scroll down list with available tags
        function update_tag_selects(tags_list) { 
            var number_of_tags = tags_list.length
            console.log("total count:" + number_of_tags)
            for (var i = 0; i < number_of_tags; i++) {
                var select_element = $("<option></option>").text(tags_list[i])
                $("#tagSelect").append(select_element)
            }
        }

        //shows the selected tag's current value
        async function display_select_value() {
            var selected_option = $("#tagSelect option:selected").text(); 
            get_value(APIkey, selected_option).then((value) => $("#currVal").text(value))
        }
        
        //change the current value of tag
        async function change_current_value() {
            var selected_option = await $("#tagSelect option:selected").text(); 
            var new_value = await $("#tagValInput").val();
            console.log("new_value", new_value)
            console.log("selected option", selected_option)
            var exists = false;
            console.log("newvalue", new_value)
            for (var i = 0; i < all_tags.length; i++) {
                if ( all_tags[i] == selected_option ) {
                    exists = true;
                }
            }
            //check type of new_value
            var inputType = input_type(new_value);
            await update_value(APIkey, selected_option, inputType, new_value);
            display_select_value();
        }


        //returns the data type indicator of tag based on given argument
        function input_type(new_value) {
            //if the value is not a number
            if ( isNaN(new_value) ) {
                //if the value is a boolean
                if (new_value == "true" || new_value == "false") {
                    return "BOOLEAN";
                }
                //if the value is a string
            return "STRING"; 
            }
            //value is a number
            else {
                //if value is an integer
                if ( Number.isInteger(parseFloat(new_value)) ) {
                    return "INT"
                }
                //if value is a double
                else {
                    return "DOUBLE"
                }
            }
        }
    </script>
</html>