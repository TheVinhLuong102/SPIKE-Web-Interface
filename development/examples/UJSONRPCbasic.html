<!DOCTYPE html>
<!-- 
Project Name: SPIKE Prime Web Interface
File name: UJSONRPCbasic.html
Author: Jeremy Jung
Last update: 6/30/20
Description: example of UJSON data stream and parsed sensor readings & hub info
Credits/inspirations:
    Based on UJSONRPC Web Serial by Ethan Danahy, Olga Sans
History: 
    Created by Jeremy on 6/28/20
LICENSE: MIT
(C) Tufts Center for Engineering Education and Outreach (CEEO)
-->
<html>
    <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src = "../libraries/JSONRPClib.js" type = "text/javascript"></script>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.plot.ly/plotly-latest.js" charset="utf-8"></script>
    <link rel = "stylesheet" href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css">
    <body>
        <head>
            <link rel = "stylesheet" type = "text/css" href = "../libraries/styles/style.css">
            <title>
                UJSON RPC basic interface
            </title>
        </head>
            <div id = "hubInfo">
                <div id = "portA" style = "left:250px; top: 20px;">
                    <div> Port A </div>
                    <div id = "portAinfo"> </div>
                </div>
                <div id = "portB" style = "left:750px; top: 20px;">
                    <div> Port B </div>
                    <div id = "portBinfo"> </div>
                </div>
                <div id = "portC" style = "left:250px; top: 170px;">
                    <div> Port C </div>
                    <div id = "portCinfo"> </div>
                </div>
                <div id = "hub" style = "left: 475px; top: 170px; width: 250px;">
                    <table id = "hubTable">
                        <tr> 
                            <th>Gyroscope:</th>
                            <td id = "gyro"> 0</td>
                        </tr>
                        <tr> 
                            <th>Accelerometer:</th>
                            <td id = "accel"> 0</td>
                        </tr>
                        <tr> 
                            <th>Position:</th>
                            <td id = "posi"> 0</td>
                        </tr>
                    </table>

                </div>
                <div id = "portD" style = "left:750px; top: 170px;">
                    <div> Port D </div>
                    <div id = "portDinfo"> </div>
                </div>
                <div id = "portE" style = "left:250px; top: 320px;">
                    <div> Port E </div>
                    <div id = "portEinfo"> </div>
                </div>
                <div id = "portF" style = "left:750px; top: 320px;">
                    <div> Port F </div>
                    <div id = "portFinfo"> </div>
                </div>
            </div>
            <div id = "jsonrpcbox">
                <center>
                    <p>
                        UJSON RPC
                    </p>
                    <input type=button id="connect" name="Connect" value="Connect">
                    <span style="background-color: red" id="connection_status">Status: Disconnected</span>
                    <input type=button id="reboot" name="Send Hub Reboot" value="Send Hub Reboot">
                    <em>Live Feed refresh every <input type="text" value="1" size="4" id="delay_amount" onchange = change_retrieval_interval() /> seconds</em>
                    <textarea cols=120 rows=5 id="REPL" name="REPL" value="" style="font-family: Courier" /></textarea>
            </center>
            <textarea cols=120 rows=5 id="data" name="data" value="" style="font-family: Courier; position: relative; left:20px" /></textarea>
            <input type=button id="send" name="Send" value="Send" style="font-family: Courier; position: relative; left: 20px">
            </div>
            <button id = "navbarbutton" class="btn"><i class="fa fa-bars"></i></button>
            <div id = "navbar" style="z-index:100;">
                <ul>
                    <li id = "browsersetup" style="z-index:100;"><a>Browser Setup</a></li>
                    <li id = "usage" style="z-index:100;"><a>Usage</a></li>
                </ul>
            </div>
            <div id = "BrowserExplanation" style = "left:200px; display:none;">
                <center>
                <p>Browser Setup (once):</p>
                </center>
                <ol>
                    <li>Open this webpage in a Chrome Browser</li>
                    <li>Go to the URL: chrome://flags</li>
                    <li>Search "Experimental Web Platform"</li>
                    <li><em>ENABLE</em> Experimental Web Platform (#enable-experimental-web-platform-features)</li>
                    <li>Restart your Chrome web browser</li>
                    <li>Plug in your SPIKE Prime hub by USB to this computer (and turn it on)!</li>
                    <li>Click "Connect" below and look for device: <em>"LEGO Technic Large Hub"</em></li>
                </ol>
                <center>
                <p><em><b>Once enabled, now you can play:</b></em></p>
                </center>
            </div>
    </body>
    <!-- when document loads -->
    <script>
        //html table elements for all device types
        var motorInfo = "<div id = \"motorInfo\">" + "<span>MOTOR</span>" + "<table id = \"motorTable\">" +"<tr>" +"<th>Speed:</th>" +"<td id = \"Mspeed\"> 0</td>" +"</tr>" +
                "<tr>" + "<th>Angle:</th>" + "<td id = \"Mangle\"> 0</td>" + "</tr>" + "<tr>" + "<th>Angle (unit circle):</th>" + "<td id = \"Muangle\" > 0</td>" +
                "</tr>" + "<tr>" + "<th> Power: </th>" + "<td id = \"Mpower\"> 0</td>" + "</tr>" + "</table>" + "</div>";

        var ultraInfo = "<div id = \"ultraInfo\">" + "<span>ULTRASONIC</span>" +  "<table id = \"ultraTable\">" + "<tr>" + "<th>Distance:</th>" + "<td id = \"Udist\"> 0</td>" + "</tr>" +
                            "</table>" + "</div>";

        var forceInfo = "<div id = \"forceInfo\">"  + "<span>FORCE</span>" + "<table id = \"forceTable\">" +  "<tr>" + "<th>Force (1-10):</th>" +
                         "<td id = \"Famount\"> 0</td>" + "</tr>" + "<tr>" + "<th>Binary</th>" + "<td id = \"Fbinary\"> 0</td>" + "</tr>" +
                        "<tr>" + "<th>Force (Sensitive):</th>" +  "<td id = \"Fbigamount\" > 0</td>" +  "</tr>" + "</table>" + "</div>";


        var colorInfo = "<div id = \"colorInfo\">" + "<span>COLOR</span>" + "<table id = \"colorTable\">" +  "<tr>" +  "<th> Reflectivity:</th>" + "<td id = \"Cdist\"> 0</td>" +
                        "</tr>" + "<tr>" + "<th>Ambient Light:</th>" +  "<td id = \"Cunknown\"> 0</td>" + "</tr>" + "<tr>" + "<th> Color (RGB):</th>" +
                        "<td id = \"Crgb\">" + "<div id = \"rgbbox\" data-r = \"0\", data-g = \"0\", data-b = \"0\"> </div> " + "</td>" +
                         "</tr>" + "</table>" + "</div>";

        var auto_get = false;
        //run when document is done loading
        $(document).ready(new function() {
            console.log("daddy's home");
            
            $("#delay_amount").on("input", function (event) {
                change_retrieval_interval();
            });

            setPortInt = setInterval( async () => {
                await display_port();
            }, 100);

            $("#navbarbutton").on("click", () => {
                toggle_navbar();
                $("#navbar").find("a.active").removeClass("active");
            })

            $("#browsersetup").on("click", () => {
                $("#navbar").find("a.active").removeClass("active");
                $("#browsersetup").find("a").addClass("active");
                $("#BrowserExplanation").css("display","block");
            })

            $("#usage").on("click", () => {
                $("#BrowserExplanation").css("display","none");
                explain = false;
                $("#navbar").find("a.active").removeClass("active");
                $("#usage").find("a").addClass("active");
            })

        });
    </script>
    <!-- For the navigation bar -->
    <script>
        explain = false;
        navbar = true;

        //toggle navigation bar
        function toggle_navbar() {
            if ( navbar ) {
                $("#navbar").css("display","none");
                $("#BrowserExplanation").css("display","none");
                navbar = false;
            }
            else {
                $("#navbar").css("display","block");
                navbar = true;
            }
        }

        //toggle explanation
        function toggle_browserex() {
            if (explain) {
                $("#BrowserExplanation").css("display","none");
                explain = false;
            }
            else {
                $("#BrowserExplanation").css("display","block");
                explain = true;
            }
        }
    </script>

    <!-- script for JSONRPC (specfically jsonrpcbox) -->
    <script>
        let connectbutton = document.getElementById('connect');
        let REPL = document.getElementById('REPL');
        let sendbutton = document.getElementById("send");
        let rebootButton =  document.getElementById("reboot");
        var getvalueInt;
        var ports;

        // SEND Hub Reboot (control-C + control-D)
        rebootButton.addEventListener( 'click', async () => {
            reboot_hub();
        });

        sendbutton.addEventListener('click', async() => {
            sendDATA(document.getElementById("data").value);
        });

        //change the interval at which data should be displayed
        var setInt
        async function change_retrieval_interval() {
            console.log( $( "#delay_amount" ).val() );
            clearInterval( setInt );
            setInt = setInterval( async () => {
                value = await retrieve_data();
                REPL.value = value;
            }, $("#delay_amount").val() * 1000)
        }

        //prompt for a connection to a specified port, start reading stream, and initialize port displays
        connectbutton.addEventListener('click', async() => {
            await setup_port();
            read_stream();
            sleep(2000).then( () => {
                display_port();
            })
        });

        //sleep function
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        //parse information about devices connected to the ports
        async function display_port() {
            ports = await get_devices();
            value = await retrieve_data();
            parsed = await JSON.parse(value);
            data = await parsed.p;
            var index_to_port = ["A","B","C","D","E","F"];
            //parse connected devices' readings
            for ( var key = 0; key < 6; key++ ) {
                letter = index_to_port[key];
                device_type = ports[letter];
                if ( device_type != "None" ) {
                    if ( device_type == "Motor" ) {
                        //this should be html to account for later disconnection
                        await $("#port" + letter + "info").html(motorInfo);
                        Mspeed = await data[key][1][0];
                        Mangle = await data[key][1][1];
                        Muangle = await data[key][1][2];
                        Mpower = await data[key][1][3];
                        $("#port" + letter).find("#Mspeed").text(Mspeed);
                        $("#port" + letter).find("#Mangle").text(Mangle);
                        $("#port" + letter).find("#Muangle").text(Muangle);
                        $("#port" + letter).find("  #Mpower").text(Mpower);
                    }
                    if ( device_type == "Ultrasonic" ) {
                        await $("#port" + letter + "info").html(ultraInfo);
                        Udist = await data[key][1][0];
                        $("#port" + letter).find("#Udist").text(Udist);
                    }
                    if ( device_type == "Force") {
                        await $("#port" + letter + "info").html(forceInfo);
                        Famount = await data[key][1][0];
                        Fbinary = await data[key][1][1];
                        Fbigamount = await data[key][1][2];
                        $("#port" + letter).find("#Famount").text(Famount);
                        $("#port" + letter).find("#Fbinary").text(Fbinary);
                        $("#port" + letter).find("#Fbigamount").text(Fbigamount);
                    }
                    if ( device_type == "Color" ) {
                        await $("#port" + letter + "info").html(colorInfo);
                        Cdist = await data[key][1][0];
                        Cunknown = await data[key][1][1];
                        Cr = await data[key][1][2];
                        Cg = await data[key][1][3];
                        Cb = await data[key][1][4];
                        $("#port" + letter).find("#Cdist").text(Cdist);
                        $("#port" + letter).find("#Cunknown").text(Cunknown);
                        $("#port" + letter).find("#rgbbox").css("background-color", "rgb(" + Cr + "," + Cg + "," + Cb + ")");
                    }
                }
                else {
                    await  $("#port" + letter + "info").html("");
                }
            }
            //parse hub information
            gyro_x = data[6][0];
            gyro_y = data[6][1];
            gyro_z = data[6][2];
            $("#gyro").text(gyro_x + ", " + gyro_y + "," + gyro_z);
            accel_x = data[7][0];
            accel_y = data[7][1];
            accel_z = data[7][2];
            $("#accel").text(accel_x + ", " + accel_y + ", " + accel_z);
            posi_x = data[8][0];
            posi_y = data[8][1];
            posi_z = data[8][2];
            $("#posi").text(posi_x + ", " + posi_y + ", " + posi_z);
        }

        //display current value when webpage loads
        change_retrieval_interval();
        $("#data").val('{"i":' + Math.floor((Math.random()*10000)) +', "m": "scratch.display_text", "p": {"text": "HELLO" } }')
    </script>
    <script src = "../libraries/hoverscript_jquery.js" type = "text/javascript"></script>
</html>